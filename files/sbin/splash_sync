#!/bin/sh
. $IPKG_INSTROOT/etc/functions.sh
x=0
config_load splash_users
test=1
myip=`uci get network.mesh.ipaddr`
splash_check() {
   timeout=6000
   current_time=`date +%s`
   config_get ip "$1" ip
   config_get time "$1" time
   local config="$1" 
   let time_check=$time+$timeout
   if [ $time_check -gt  $current_time ]; then
   	# User ist noch gesplashed
   	iptables  -t nat -D ffj_splash -s $ip -j ACCEPT
   	iptables  -t nat -I ffj_splash 1 -s $ip -j ACCEPT
   else
   	# User is not longer splashed / the user must click again
   	iptables -t nat -D ffj_splash -s $ip -j ACCPET
   	uci delete splash_users.@user[$x].ip
   	uci delete splash_users.@user[$x].time
   	uci delete splash_users.@user[$x]     
   	uci commit
   fi
   let x=$x+1
}
#chain refresh
iptables -t nat -D zone_mesh_prerouting -p tcp -j ffj_splash 
iptables -t nat -F ffj_splash
iptables -t nat -X ffj_splash 
#recreation
iptables -t nat -N ffj_splash
iptables -t nat -I zone_mesh_prerouting 1 -p tcp -j ffj_splash
config_foreach splash_check user
iptables -t nat -A ffj_splash -p tcp -j DNAT --to $myip:80

                                               

